<?php
/** @var \ADM\QuickDevBar\Block\Toolbar $block */
?>
<!-- Start:ADM_QuickDevBar -->
<!--
           ____        _      _    _____             ____
          / __ \      (_)    | |  |  __ \           |  _ \
         | |  | |_   _ _  ___| | _| |  | | _____   _| |_) | __ _ _ __
         | |  | | | | | |/ __| |/ / |  | |/ _ \ \ / /  _ < / _` | '__|
         | |__| | |_| | | (__|   <| |__| |  __/\ V /| |_) | (_| | |
          \___\_\\__,_|_|\___|_|\_\_____/ \___| \_/ |____/ \__,_|_|


 -->
<div id="qdb-bar" style="display: none;">
    <?=  $block->getChildHtml(); ?>
</div>
<div
     id="qdb-bar-anchor">
    <img src="<?=  $block->getViewFileUrl('ADM_QuickDevBar::images/qdb-icon.png') ?>"
         alt="<?=  __('QuickDevBar'); ?>"
         title="<?=  __('Click to toggle the Quick Development Toolbar'); ?>"/>&nbsp;
</div>
<div id='qdb-action-loader' style="display:none"><?=  $block->getHtmlLoader()?></div>


<script>
    (function () {
        "use strict";

        window.quickDevBar = {
            options: {
                etTabWrapper: "qdb-bar",
                elAnchor: "qdb-bar-anchor",
                baseUrl: "<?= $block->getBaseUrl() ?>",
                ajaxLoading:  <?= $block->isAjaxLoading() ?>,
                assetsScript: {
                    filtertable: "<?= $block->getViewFileUrl('ADM_QuickDevBar::js/filter-table.js') ?>",
                    tablesorter: "<?= $block->getViewFileUrl('ADM_QuickDevBar::js/sortable-table.js') ?>",
                    tab: "<?= $block->getViewFileUrl('ADM_QuickDevBar::js/tabbis/assets/js/src/tabbis.es6.js') ?>",
                },
                awaitScript: {},
                assetsCss: {
                    default: "<?= $block->getViewFileUrl('ADM_QuickDevBar::css/quickdevbar.css') ?>",
                },
                stripedClassname: "striped",
                classToStrip: "qdb_table.striped",
                classToFilter: "qdb_table.filterable",
                classToSort: "qdb_table.sortable",
            },
            tabsObj: null,
            /** @see https://stackoverflow.com/a/69616316 */
            addScript: ((src) => new Promise((resolve, reject) => {
                const el = document.createElement('script');
                el.src = src;
                el.addEventListener('load', resolve);
                el.addEventListener('error', reject);
                document.body.append(el);
            })),
            addCss: function (href) {
                const el = document.createElement('link');
                el.href = href;
                el.rel = "stylesheet";
                el.type = "text/css";
                document.body.append(el);
            },
            eventClickAnchor: function () {
                const $qdbBar = document.getElementById(this.options.etTabWrapper);
                const $qdbBarAnchor = document.getElementById(this.options.elAnchor);
                $qdbBarAnchor.addEventListener("click", () => {
                    $qdbBar.style.display = ($qdbBar.style.display === 'none') ? '': 'none';
                });
            },
            run: function () {
                this.eventClickAnchor();
                document.addEventListener('tabbis_pane_ajax_loaded', (event) => {
                    this.applyTabPlugin(event.detail.pane);
                });

                this.addCss(this.options.assetsCss.default);

                /** @see https://usefulangle.com/post/343/javascript-load-multiple-script-by-order */
                let scriptPromises = [];
                for (let scriptKey in this.options.assetsScript) {
                    scriptPromises.push(this.addScript(this.options.assetsScript[scriptKey]));
                }

                Promise.all(scriptPromises)
                    .then(function() {
                        if(this.options.ajaxLoading) {
                            this.qdbFetchPromise("quickdevbar/index/ajax").then(html => {
                                const wrapperElem =  document.getElementById(this.options.etTabWrapper);
                                wrapperElem.innerHTML = html;
                                this.executeScriptElements(wrapperElem);
                            }).then(()=>{
                                this.tabsObj= new tabbisClass({memory: true});
                                this.applyTabPlugin(document);
                            });
                        } else {
                            this.tabsObj= new tabbisClass({memory: true});
                            this.applyTabPlugin(document);
                        }
                    }.bind(this))
                    .catch((err) => console.error("Error loading js scripts", 'QDB Error'));

                //TODO: Theme
                // let qdbTheme = $.mage.cookies.get('qdb_theme');
                // if(qdbTheme) {
                //     this.element.attr('data-theme', qdbTheme);
                // }

            },
            showLoader:function(target, type) {
                document.getElementById(target).innerHTML= document.getElementById('qdb-action-loader').innerHTML;
            },
            saveUserData:function(key, value) {
                localStorage.setItem(this.options.memory, JSON.stringify(this.memory));
            },
            loadUserData:function(key) {
                localStorage.getItem(this.options.memory, JSON.stringify(this.memory));
            },
            /**
             * @see https://stackoverflow.com/a/69190644
             * @param containerElement
             */
            executeScriptElements:function (containerElement) {
                const scriptElements = containerElement.querySelectorAll("script");

                Array.from(scriptElements).forEach((scriptElement) => {
                    const clonedElement = document.createElement("script");

                    Array.from(scriptElement.attributes).forEach((attribute) => {
                        clonedElement.setAttribute(attribute.name, attribute.value);
                    });

                    clonedElement.text = scriptElement.text;

                    scriptElement.parentNode.replaceChild(clonedElement, scriptElement);
                });
            },
            qdbFetchPromise: function (routePath) {
                const url = this.options.baseUrl + routePath;
                return fetch(url, {
                        //To be compliant with \Laminas\Http\Request::isXmlHttpRequest
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                        }
                    }
                ).then(response => {
                    if (!response.ok || response.status !==200) {
                        throw new Error(response.status + " Failed Fetch ");
                    }
                    return response.text()
                }).catch((err) => console.error("Can’t access " + url + ". Error " + err, 'QDB Error'));
            },
            /**
             *  Apply enhancement on table
             */
            applyTabPlugin: function (ref) {
                //Sort
                ref.querySelectorAll('table.qdb_table.sortable').forEach((table)=> new SortableTable(table))
                //Filter
                ref.querySelectorAll('table.qdb_table.filterable').forEach((table)=> new FilterTable(table))

                /* classToStrip: Set odd even class on tr */
                ref.querySelectorAll('table.' + this.options.classToStrip + ' :nth-of-type(odd)').forEach(function (tr) {
                    tr.classList.add(this.options.stripedClassname);
                }.bind(this));

                this.addIdeClickEvent(ref);

            },
            /**
             *  Add hyperlink to IDE on file path
             */
            addIdeClickEvent: function(ref) {
                ref.querySelectorAll('span[data-ide-file]:not([data-ide-file=""])').forEach(function (span) {
                    span.addEventListener(
                        "click",
                        (event) => {
                            let ideFile = event.target.getAttribute('data-ide-file');
                            fetch(ideFile).catch((err) => console.error("Can’t access " + url + " response. Blocked by browser?" + err, 'QDB Error'));
                        },
                        false,
                    );
                });
            }
        }
        document.addEventListener('DOMContentLoaded', (event) => {
            window.quickDevBar.run();
        });
    }());
</script>

<!-- End:ADM_QuickDevBar -->
